<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZAIN NETWORK v45</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlpBSU4gTkVUV09SSyIsCiAgInNob3J0X25hbWUiOiAiWkFJTml0IiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAic2NvcGUiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMzMTMzMzgiLAogICJ0aGVtZV9jb2xvciI6ICIjNTg2NWYyIgp9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
    <style>
        :root { --bg: #313338; --side: #2b2d31; --accent: #5865f2; --text: #dbdee1; --msg-bg: #383a40; --input-bg: rgba(0,0,0,0.2); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        input, select { background: var(--input-bg) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: var(--text) !important; padding: 15px; border-radius: 15px; width: 100%; outline: none; }
        .sidebar { width: 300px; background: var(--side); height: 100vh; display: flex; flex-direction: column; position: fixed; right: 0; transition: 0.4s; z-index: 1000; border-left: 1px solid rgba(0,0,0,0.2); }
        .sidebar.hidden { transform: translateX(100%); }
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100vw; height: 100vh; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-top: 80px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 20px; background: var(--msg-bg); align-self: flex-start; display: flex; gap: 10px; }
        .msg.mine { align-self: flex-end; background: var(--accent); color: white; flex-direction: row-reverse; }
        .msg img { max-width: 100%; max-height: 300px; border-radius: 10px; }
        .avatar { width: 45px; height: 45px; border-radius: 15px; object-fit: cover; border: 2px solid var(--accent); }
        .toggle-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; background: var(--accent); color: white; border: none; width: 45px; height: 45px; border-radius: 12px; }
        .input-bar { padding: 20px; background: var(--side); display: flex; gap: 10px; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; align-items: center; justify-content: center; }
        .modal-content { background: var(--side); padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center; background:var(--side); padding:40px; border-radius:30px; width:85%; max-width:380px;">
        <h1 style="color:var(--accent); margin:0;">ZAIN NET</h1>
        <p style="opacity:0.5; margin-bottom:20px;">V45 | Final Notify</p>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="unlock()" style="background:var(--accent); color:white; border:none; padding:15px; width:100%; border-radius:15px; margin-top:15px; font-weight:bold;">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--accent);">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <input type="text" id="newN" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin-bottom:10px;">
        <input type="text" id="newP" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" style="margin-bottom:10px;">
        <input type="password" id="newPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="margin-bottom:10px;">
        <button onclick="requestPermission()" style="background:#43b581; color:white; border:none; padding:12px; width:100%; border-radius:10px; margin-bottom:10px; font-weight:bold;">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ø¶ØºØ· Ù‡Ù†Ø§)</button>
        <div style="display:flex; gap:10px;">
            <button onclick="saveSettings()" style="background:var(--accent); color:white; border:none; padding:12px; flex:1; border-radius:10px;">Ø­ÙØ¸</button>
            <button onclick="closeSettings()" style="background:#555; color:white; border:none; padding:12px; flex:1; border-radius:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<button id="toggleBtn" class="toggle-btn" style="display:none;" onclick="toggleSidebar()">â˜°</button>

<div class="sidebar" id="sidebar">
    <div style="padding:25px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.05);">
        <img id="myPfp" src="" class="avatar" style="width:65px; height:65px;">
        <div id="myName" style="font-weight:800; margin-top:5px;"></div>
        <div id="myIDDisplay" style="font-size:0.7rem; opacity:0.5;"></div>
        <button onclick="openSettings()" style="background:none; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; margin-top:10px; font-size:0.8rem;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
    <div style="flex:1; overflow-y:auto; padding:15px;">
        <button onclick="addNewFriend()" style="background:var(--accent); width:100%; padding:12px; border:none; border-radius:12px; color:white; font-weight:bold; margin-bottom:15px;">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
        <div id="friendsList"></div>
    </div>
    <div style="padding:15px;"><button onclick="location.reload()" style="background:#ed4245; width:100%; padding:12px; border:none; border-radius:12px; color:white; font-weight:bold;">Ø®Ø±ÙˆØ¬</button></div>
</div>

<div class="main-content">
    <div id="messages"></div>
    <div class="input-bar">
        <input type="text" id="msgIn" placeholder="Ø§ÙƒØªØ¨..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()" style="background:var(--accent); color:white; border:none; padding:0 20px; border-radius:12px; font-weight:bold;">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
    let pubnub, myID = localStorage.getItem('zain_id') || Math.floor(Math.random()*8999)+1000;
    localStorage.setItem('zain_id', myID);
    let friends = JSON.parse(localStorage.getItem('my_friends_v2') || "[]"), currentFid = null;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± ---
    function requestPermission() {
        if (!('Notification' in window)) {
            alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ ØªØ£ÙƒØ¯ Ø§Ù†Ùƒ ÙØªØ­ØªÙ‡ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.");
            return;
        }
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„! Ø³ØªØµÙ„Ùƒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù† âœ…");
                new Notification("ZAIN NET", { body: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!" });
            } else {
                alert("Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙŠÙÙˆÙ†.");
            }
        });
    }

    function notifyMe(sender, text) {
        if (Notification.permission === 'granted') {
            new Notification(sender, { body: text, icon: 'https://cdn-icons-png.flaticon.com/512/733/733579.png' });
        }
        // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¶Ø§ÙÙŠ
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        audio.play();
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsgfSk7');
    }

    function unlock() {
        if(document.getElementById('passInput').value !== (localStorage.getItem('my_pass') || "123")) return alert("Ø®Ø·Ø£!");
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('toggleBtn').style.display = 'block';
        initPN(); loadUI(); renderFriends();
    }

    function initPN() {
        pubnub = new PubNub({ publishKey: "pub-c-90243370-fb67-4c9c-914f-77acbcade771", subscribeKey: "sub-c-bc8811a4-c349-4df5-8896-9a7cf29ad727", uuid: myID.toString() });
        pubnub.addListener({ message: (m) => { 
            if(m.channel.includes(currentFid)) renderMsg(m.message);
            else if(m.message.uid != myID) notifyMe(m.message.name, m.message.text);
        }});
        friends.forEach(f => pubnub.subscribe({ channels: ["v8_chat_" + [myID, f.id].sort().join("_")] }));
    }

    function renderMsg(data) {
        const box = document.getElementById('messages'), isMine = data.uid == myID, div = document.createElement('div');
        div.className = `msg ${isMine ? 'mine' : ''}`;
        div.innerHTML = `<div><div style="font-size:0.6rem; font-weight:bold;">${data.name}</div><div>${data.text}</div></div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function send() {
        const inp = document.getElementById('msgIn'); if(!inp.value.trim() || !currentFid) return;
        pubnub.publish({ channel: "v8_chat_" + [myID, currentFid].sort().join("_"), message: { text: inp.value, uid: myID, name: localStorage.getItem('zain_name') || "Ù…Ø³ØªØ®Ø¯Ù…" } });
        inp.value = "";
    }

    function renderFriends() {
        const list = document.getElementById('friendsList'); list.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div'); div.className = 'friend-card';
            div.style = `padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:5px; cursor:pointer; border:1px solid ${currentFid==f.id?'#5865f2':'transparent'}`;
            div.innerHTML = `<b>${f.name}</b> <span style="font-size:0.7rem; opacity:0.5;">#${f.id}</span>`;
            div.onclick = () => openChat(f.id); list.appendChild(div);
        });
    }

    function openChat(id) { currentFid = id; renderFriends(); document.getElementById('messages').innerHTML = ""; toggleSidebar(); }
    function addNewFriend() { const id = prompt("ID Ø§Ù„ØµØ¯ÙŠÙ‚:"); if(id) { const name = prompt("Ø§Ù„Ø§Ø³Ù…:"); friends.push({id, name}); localStorage.setItem('my_friends_v2', JSON.stringify(friends)); renderFriends(); }}
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() { localStorage.setItem('zain_name', document.getElementById('newN').value); localStorage.setItem('my_pass', document.getElementById('newPass').value); location.reload(); }
    function loadUI() { document.getElementById('myName').innerText = localStorage.getItem('zain_name') || "Ù…Ø³ØªØ®Ø¯Ù… #" + myID; document.getElementById('myIDDisplay').innerText = "ID: " + myID; document.getElementById('myPfp').src = localStorage.getItem('zain_pic') || "https://www.gravatar.com/avatar/" + myID + "?d=identicon"; }
</script>
</body>
</html>
