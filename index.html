<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZAIN NETWORK v49</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlpBSU4gTkVUV09SSyIsCiAgInNob3J0X25hbWUiOiAiWkFJTml0IiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMjAwOTNlIiwKICAidGhlbWVfY29sb3IiOiAiIzYxMzE5ZCJ9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
    <style>
        :root { --main-bg: #20093e; --card-bg: #301654; --accent: #9b59b6; --text: #ffffff; --btn-green: #52b788; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--main-bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        input { background: rgba(0,0,0,0.3) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: #fff !important; padding: 18px; border-radius: 20px; outline: none; width: 100%; text-align: center; }
        .sidebar { width: 320px; background: var(--main-bg); height: 100vh; display: flex; flex-direction: column; position: fixed; right: 0; transition: 0.4s; z-index: 1000; padding: 20px; border-left: 1px solid rgba(255,255,255,0.05); }
        .sidebar.hidden { transform: translateX(100%); }
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100vw; height: 100vh; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-top: 80px; }
        .msg-box { max-width: 80%; padding: 15px; border-radius: 22px; background: var(--card-bg); align-self: flex-start; border: 1px solid rgba(255,255,255,0.05); }
        .msg-box.mine { align-self: flex-end; background: var(--accent); }
        .input-area { padding: 20px; background: var(--main-bg); display: flex; gap: 12px; padding-bottom: env(safe-area-inset-bottom, 25px); }
        .btn-purple { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 22px; width: 100%; font-weight: 800; cursor: pointer; margin-bottom: 10px; }
        .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 2000; background: var(--accent); color: white; width: 45px; height: 45px; border-radius: 15px; border: none; }
        .friend-item { background: var(--card-bg); padding: 15px; border-radius: 22px; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .friend-item.active { border: 2px solid var(--accent); }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:var(--main-bg); z-index:5000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(10px);">
    <div style="background:var(--card-bg); padding:40px; border-radius:35px; width:90%; max-width:380px; text-align:center;">
        <h1 style="color:var(--accent); margin:0; font-weight:900;">ZAIN NETWORK</h1>
        <p style="opacity:0.5; margin-bottom:25px;">V49 | Push Master</p>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">
        <button onclick="unlock()" class="btn-purple" style="margin-top:20px;">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<button id="toggleBtn" class="menu-toggle" style="display:none;" onclick="toggleSidebar()">â˜°</button>

<div class="sidebar" id="sidebar">
    <div style="text-align:center; margin-bottom:20px;">
        <img id="myPfp" src="" style="width:80px; height:80px; border-radius:25px; border:3px solid var(--accent);">
        <div id="myName" style="font-weight:800; font-size:1.2rem; margin-top:10px;"></div>
        <button onclick="requestPush()" style="background:var(--btn-green); color:white; border:none; padding:8px 15px; border-radius:12px; font-size:0.7rem; margin-top:10px; font-weight:bold;">ğŸ”” ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
    </div>
    <div style="flex:1; overflow-y:auto;">
        <button onclick="addNewFriend()" class="btn-purple">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
        <div id="friendsList"></div>
    </div>
    <button onclick="location.reload()" style="background:#e63946; color:white; border:none; padding:15px; border-radius:18px; font-weight:bold;">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<div class="main-content">
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="msgIn" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()" style="background:var(--accent); border:none; color:white; padding:0 25px; border-radius:18px; font-weight:bold;">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
    let pubnub, myID = localStorage.getItem('zain_id') || Math.floor(Math.random()*899)+100;
    localStorage.setItem('zain_id', myID);
    let friends = JSON.parse(localStorage.getItem('my_friends_v2') || "[]"), currentFid = null;

    // --- Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: ÙƒÙˆØ¯ Ø§Ù„Ù€ Service Worker Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ÙŠØ© ---
    async function requestPush() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„! Ø³Ø£Ø­Ø§ÙˆÙ„ ØªÙ†Ø¨ÙŠÙ‡Ùƒ Ø­ØªÙ‰ ÙˆØ£Ù†Øª Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© ğŸš€");
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdwdXNoJywgZSA9PiB7IGNvbnN0IGQgPSBlLmRhdGEuanNvbigpOyBzZWxmLnJlZ2lzdHJhdGlvbi5zaG93Tm90aWZpY2F0aW9uKGQudGl0bGUsIHsgYm9keTogZC5ib2R5IH0pOyB9KTs=');
        }
    }

    function triggerNotify(title, body) {
        if (Notification.permission === 'granted') {
            new Notification(title, { body: body, icon: localStorage.getItem('zain_pic') });
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        }
    }

    function unlock() {
        if(document.getElementById('passInput').value !== (localStorage.getItem('my_pass') || "123")) return alert("Ø®Ø·Ø£");
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('toggleBtn').style.display = 'block';
        initPN(); loadUI(); renderFriends();
    }

    function initPN() {
        pubnub = new PubNub({ publishKey: "pub-c-90243370-fb67-4c9c-914f-77acbcade771", subscribeKey: "sub-c-bc8811a4-c349-4df5-8896-9a7cf29ad727", uuid: myID.toString() });
        pubnub.addListener({ message: (m) => { 
            if(m.channel.includes(currentFid)) renderMsg(m.message);
            else if(m.message.uid != myID) triggerNotify(m.message.name, m.message.text);
        }});
        friends.forEach(f => pubnub.subscribe({ channels: ["v8_chat_" + [myID, f.id].sort().join("_")] }));
    }

    function renderMsg(data) {
        const box = document.getElementById('messages'), isMine = data.uid == myID, div = document.createElement('div');
        div.className = `msg-box ${isMine ? 'mine' : ''}`;
        div.innerHTML = `<div style="font-size:0.7rem; font-weight:800; opacity:0.5; margin-bottom:4px;">${data.name}</div><div>${data.text}</div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function loadHistory(chan) {
        pubnub.history({ channel: chan, count: 50 }, (s, res) => {
            if (res.messages) {
                document.getElementById('messages').innerHTML = "";
                res.messages.forEach(m => renderMsg(m.entry));
            }
        });
    }

    function openChat(id) {
        currentFid = id; renderFriends();
        loadHistory("v8_chat_" + [myID, id].sort().join("_"));
        if(window.innerWidth < 600) toggleSidebar();
    }

    function send() {
        const inp = document.getElementById('msgIn'); if(!inp.value.trim() || !currentFid) return;
        pubnub.publish({ channel: "v8_chat_" + [myID, currentFid].sort().join("_"), message: { text: inp.value, uid: myID, name: localStorage.getItem('zain_name') || "Ù…Ø³ØªØ®Ø¯Ù…" } });
        inp.value = "";
    }

    function renderFriends() {
        const list = document.getElementById('friendsList'); list.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div'); div.className = `friend-item ${currentFid == f.id ? 'active' : ''}`;
            div.innerHTML = `<img src="https://www.gravatar.com/avatar/${f.id}?d=identicon" style="width:40px; height:40px; border-radius:50%;">
            <div style="flex:1;"><b>${f.name}</b><div style="font-size:0.7rem; opacity:0.5;">ID: ${f.id}</div></div>`;
            div.onclick = () => openChat(f.id); list.appendChild(div);
        });
    }

    function addNewFriend() {
        const id = prompt("ID Ø§Ù„ØµØ¯ÙŠÙ‚:"); const name = prompt("Ø§Ù„Ø§Ø³Ù…:");
        if(id && name) { friends.push({id, name}); localStorage.setItem('my_friends_v2', JSON.stringify(friends)); renderFriends(); }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    function loadUI() {
        document.getElementById('myName').innerText = localStorage.getItem('zain_name') || "ZAIN USER";
        document.getElementById('myPfp').src = localStorage.getItem('zain_pic') || "https://www.gravatar.com/avatar/" + myID + "?d=identicon";
    }
</script>
</body>
</html>
