<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZAIN NETWORK v47</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlpBSU4gTkVUV09SSyIsCiAgInNob3J0X25hbWUiOiAiWkFJTml0IiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMzEzMzM4IiwKICAidGhlbWVfY29sb3IiOiAiIzU4NjVmMiIKfQ==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
    <style>
        :root { --bg: #313338; --side: #2b2d31; --accent: #5865f2; --text: #dbdee1; --msg-bg: #383a40; --input-bg: rgba(0,0,0,0.2); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        input { background: var(--input-bg) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: var(--text) !important; padding: 15px; border-radius: 15px; outline: none; width: 100%; }
        .sidebar { width: 300px; background: var(--side); height: 100vh; display: flex; flex-direction: column; position: fixed; right: 0; transition: 0.4s; z-index: 1000; border-left: 1px solid rgba(0,0,0,0.2); }
        .sidebar.hidden { transform: translateX(100%); }
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100vw; height: 100vh; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-top: 85px; }
        .msg { max-width: 80%; padding: 14px; border-radius: 20px; background: var(--msg-bg); align-self: flex-start; display: flex; gap: 10px; }
        .msg.mine { align-self: flex-end; background: var(--accent); color: white; flex-direction: row-reverse; }
        .avatar { width: 45px; height: 45px; border-radius: 14px; object-fit: cover; border: 2px solid var(--accent); }
        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; color: white; margin-bottom: 10px; }
        .toggle-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; background: var(--accent); color: white; border: none; width: 50px; height: 50px; border-radius: 15px; }
        .input-bar { padding: 20px; background: var(--side); display: flex; gap: 10px; padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center; background:var(--side); padding:40px; border-radius:30px; width:85%; max-width:380px;">
        <h1 style="color:var(--accent); font-weight:900;">ZAIN NET</h1>
        <p style="opacity:0.5;">V47 | Recovery Edition</p>
        <input type="password" id="passInput" placeholder="الرمز (الافتراضي 123)">
        <button onclick="unlock()" style="background:var(--accent); color:white; border:none; padding:16px; width:100%; border-radius:15px; margin-top:20px; font-weight:bold;">دخول</button>
    </div>
</div>

<button id="toggleBtn" class="toggle-btn" style="display:none;" onclick="toggleSidebar()">☰</button>

<div class="sidebar" id="sidebar">
    <div style="padding:30px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.05);">
        <img id="myPfp" src="" class="avatar" style="width:70px; height:70px;">
        <div id="myName" style="font-weight:800; font-size:1.2rem; margin-top:10px;"></div>
        <div id="myIDDisplay" style="font-size:0.75rem; opacity:0.5; font-weight:bold;"></div>
    </div>
    <div style="flex:1; overflow-y:auto; padding:20px;">
        <button onclick="addNewFriend()" class="btn-action" style="background:var(--accent);">➕ إضافة صديق</button>
        <div id="friendsList"></div>
    </div>
</div>

<div class="main-content">
    <div id="messages"></div>
    <div class="input-bar">
        <input type="text" id="msgIn" placeholder="اكتب..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()" style="background:var(--accent); color:white; border:none; padding:0 25px; border-radius:15px; font-weight:bold;">إرسال</button>
    </div>
</div>

<script>
    let pubnub, myID = localStorage.getItem('zain_id') || Math.floor(Math.random()*8999)+1000;
    localStorage.setItem('zain_id', myID);
    let friends = JSON.parse(localStorage.getItem('my_friends_v2') || "[]"), currentFid = null;

    function unlock() {
        let savedPass = localStorage.getItem('my_pass') || "123";
        if(document.getElementById('passInput').value !== savedPass) return alert("الرمز خطأ!");
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('toggleBtn').style.display = 'block';
        initPN(); loadUI(); renderFriends();
    }

    function initPN() {
        pubnub = new PubNub({ publishKey: "pub-c-90243370-fb67-4c9c-914f-77acbcade771", subscribeKey: "sub-c-bc8811a4-c349-4df5-8896-9a7cf29ad727", uuid: myID.toString() });
        pubnub.addListener({ message: (m) => { 
            if(m.channel.includes(currentFid)) renderMsg(m.message);
            else if(m.message.uid != myID) {
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
                if(Notification.permission === 'granted') new Notification(m.message.name, {body: m.message.text});
            }
        }});
        friends.forEach(f => pubnub.subscribe({ channels: ["v8_chat_" + [myID, f.id].sort().join("_")] }));
    }

    function renderMsg(data) {
        const box = document.getElementById('messages'), isMine = data.uid == myID, div = document.createElement('div');
        div.className = `msg ${isMine ? 'mine' : ''}`;
        div.innerHTML = `<div style="font-size:0.7rem; font-weight:800; opacity:0.6;">${data.name}</div><div>${data.text}</div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    // جلب الرسائل القديمة (عشان ما تحس إن الشات انحذف)
    function loadHistory(chan) {
        pubnub.history({ channel: chan, count: 50 }, (status, response) => {
            if (response.messages) {
                document.getElementById('messages').innerHTML = "";
                response.messages.forEach(m => renderMsg(m.entry));
            }
        });
    }

    function openChat(id) {
        currentFid = id; renderFriends();
        const chan = "v8_chat_" + [myID, id].sort().join("_");
        loadHistory(chan);
        if(window.innerWidth < 600) toggleSidebar();
    }

    function send() {
        const inp = document.getElementById('msgIn'); if(!inp.value.trim() || !currentFid) return;
        pubnub.publish({ 
            channel: "v8_chat_" + [myID, currentFid].sort().join("_"), 
            message: { text: inp.value, uid: myID, name: localStorage.getItem('zain_name') || "مستخدم" } 
        });
        inp.value = "";
    }

    function renderFriends() {
        const list = document.getElementById('friendsList'); list.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div');
            div.style = `padding:15px; background:rgba(255,255,255,0.05); border-radius:15px; margin-bottom:10px; cursor:pointer; border:1px solid ${currentFid==f.id?'#5865f2':'transparent'}`;
            div.innerHTML = `<b>${f.name}</b> <small style="opacity:0.5;">#${f.id}</small>`;
            div.onclick = () => openChat(f.id); list.appendChild(div);
        });
    }

    function addNewFriend() {
        const id = prompt("ID الصديق:");
        const name = prompt("الاسم:");
        if(id && name) { friends.push({id, name}); localStorage.setItem('my_friends_v2', JSON.stringify(friends)); renderFriends(); location.reload(); }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    function loadUI() {
        document.getElementById('myName').innerText = localStorage.getItem('zain_name') || "مستخدم #" + myID;
        document.getElementById('myIDDisplay').innerText = "ID: " + myID;
        document.getElementById('myPfp').src = "https://www.gravatar.com/avatar/" + myID + "?d=identicon";
    }
</script>
</body>
</html>
